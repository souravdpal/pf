<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blog · Post</title>
      <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/blog.css">
  <!-- Sanitize Quill HTML safely -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js" defer></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1 id="title" class="title skeleton" style="min-height:2.4em"></h1>
      <div id="meta" class="meta" style="visibility:hidden">
        <span id="date" class="chip"></span>
        <span id="reading" class="chip"></span>
        <span id="idchip" class="chip"></span>
      </div>
      <div id="hero" class="hero" style="display:none">
        <img id="heroImg" alt="Blog cover" loading="lazy" />
      </div>
      <article id="content" class="content"></article>
      <div class="footer">
        <a class="btn" id="backBtn" href="/">← Back</a>
        <a class="btn" id="openApi" target="_blank" rel="noopener">View JSON</a>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const qs = new URLSearchParams(location.search);
      const id = qs.get('id');
      const titleEl = document.getElementById('title');
      const metaEl  = document.getElementById('meta');
      const dateEl  = document.getElementById('date');
      const readEl  = document.getElementById('reading');
      const idEl    = document.getElementById('idchip');
      const contentEl = document.getElementById('content');
      const heroWrap = document.getElementById('hero');
      const heroImg  = document.getElementById('heroImg');
      const openApi  = document.getElementById('openApi');

      if(!id){
        titleEl.classList.remove('skeleton');
        titleEl.textContent = 'Missing ?id=... in URL';
        contentEl.innerHTML = '<p>Please open this page like <code>/blog.html?id=POST_ID</code>.</p>';
        return;
      }

      const apiUrl = `/blog/${encodeURIComponent(id)}`;
      openApi.href = apiUrl;

      fetch(apiUrl)
        .then(r => {
          if(!r.ok) throw new Error('Failed to fetch post');
          return r.json();
        })
        .then(data => {
          // Title
          titleEl.classList.remove('skeleton');
          titleEl.textContent = data.title || 'Untitled';

          // Meta
          const date = data.createdAt ? new Date(data.createdAt) : null;
          dateEl.textContent = date ? `Published · ${date.toLocaleString([], {year:'numeric', month:'short', day:'2-digit'})}` : 'Draft';
          idEl.textContent = `id · ${data._id || 'unknown'}`;
          readEl.textContent = `${estimateReadMins(data.content)} min read`;
          metaEl.style.visibility = 'visible';

          // Hero image
          if (data.image && data.image !== 'null' && String(data.image).trim() !== ''){
            heroImg.src = data.image;
            heroWrap.style.display = 'block';
          }

          // Content (Quill HTML) — sanitize for safety
          const clean = DOMPurify.sanitize(data.content || '', { USE_PROFILES: { html: true } });
          contentEl.innerHTML = clean;
        })
        .catch(err => {
          titleEl.classList.remove('skeleton');
          titleEl.textContent = 'Post not found';
          contentEl.innerHTML = `<p style="color:#fca5a5">${err.message}</p>`;
        });

      function estimateReadMins(html){
        const tmp = document.createElement('div');
        tmp.innerHTML = html || '';
        const text = tmp.textContent || tmp.innerText || '';
        const words = text.trim().split(/\s+/).filter(Boolean).length;
        const mins = Math.max(1, Math.round(words / 200));
        return mins;
      }
    })();
  </script>
</body>
</html>
